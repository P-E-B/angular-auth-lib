import { __decorate, __param, __read } from "tslib";
import { Injectable, Inject } from '@angular/core';
import { Router } from '@angular/router';
import { Actions, Effect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { ToastrService } from 'ngx-toastr';
import { Store, select } from '@ngrx/store';
import { MatDialogRef, MatDialog } from '@angular/material/dialog';
import { map, switchMap, catchError, tap, withLatestFrom, concatMap } from 'rxjs/operators';
import { get } from 'lodash';
import { AUTH_ACTIONS_TYPE, LogInSuccess, LogInFailure, SignUpFailure, SignUpSuccess, ChangePasswordSuccess, ChangePasswordFailure, LoadUserInformationSuccess, LoadUserInformationFailure, SendPasswordSuccess, SendPasswordFailure } from './actions';
import { selectUser } from './selectors';
import { AuthService } from '../services/auth.service';
import { ForgottenPasswordComponent } from '../components/forgotten-password/forgotten-password.component';
import { AUTH_RESET_ACTIONS, AUTH_TRADUCTIONS } from '../token';
import { SignUpComponent } from '../components/sign-up/sign-up.component';
var AuthEffects = /** @class */ (function () {
    function AuthEffects(resetActions, traductions, actions, authService, router, toastService, dialog, store) {
        var _this = this;
        this.resetActions = resetActions;
        this.traductions = traductions;
        this.actions = actions;
        this.authService = authService;
        this.router = router;
        this.toastService = toastService;
        this.dialog = dialog;
        this.store = store;
        this.OpenSignUpDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_SIGN_UP_DIALOG), tap(function () { return _this.dialogRef = _this.dialog.open(SignUpComponent); }));
        this.SignUp$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP), map(function (action) { return action.payload; }), switchMap(function (user) { return _this.authService.createUser(user).pipe(map(function () { return new SignUpSuccess(); }), catchError(function (error) { return of(new SignUpFailure(error)); })); }));
        this.SignUpSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_SUCCESS), tap(function () {
            _this.toastService.success(get(_this.traductions || {}, 'messages.signupSuccess', 'Your account has been created!'));
        }));
        this.SignUpFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.signupFailure', 'Please try again with a new username.')); }));
        this.LogIn$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN), map(function (action) { return action.payload; }), switchMap(function (user) { return _this.authService.login(user).pipe(concatMap(function (loggedInUser) {
            sessionStorage.setItem('token', loggedInUser.token.token);
            return _this.authService.getUserInformation().pipe(map(function (_a) {
                var user = _a.user, usersList = _a.usersList;
                return new LogInSuccess({ user: user, usersList: usersList });
            }), catchError(function (error) { return of(new LogInFailure(error)); }));
        }), catchError(function (error) { return of(new LogInFailure(error)); })); }));
        this.LogInSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_SUCCESS), withLatestFrom(this.store.pipe(select(selectUser))), tap(function (_a) {
            var _b = __read(_a, 2), action = _b[0], user = _b[1];
            var redirectedUrlAfterLogIn = sessionStorage.getItem('redirectedUrlAfterLogIn');
            if (redirectedUrlAfterLogIn) {
                _this.router.navigateByUrl(redirectedUrlAfterLogIn);
                sessionStorage.removeItem('redirectedUrlAfterLogIn');
            }
            else {
                _this.router.navigateByUrl(user.redirectUrlAfterLogin);
            }
            _this.toastService.success(get(_this.traductions || {}, 'messages.loginSuccess', 'Hi! Nice to see you again!'));
        }));
        this.LogInFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.loginFailure', 'Wrong credentials. Please check again.')); }));
        this.LogOut$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_OUT), switchMap(function (action) {
            sessionStorage.removeItem('token');
            _this.router.navigate(['log-in']);
            return (_this.resetActions || []).map(function (resetAction) { return new resetAction(); });
        }));
        this.LoadUserInformation$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOAD_USER_INFORMATION), switchMap(function (action) { return _this.authService.getUserInformation().pipe(map(function (_a) {
            var user = _a.user, usersList = _a.usersList;
            return new LoadUserInformationSuccess(user);
        }), catchError(function (error) { return of(new LoadUserInformationFailure(error)); })); }));
        this.ChangePassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD), switchMap(function (action) { return _this.authService.changePassword(action.payload).pipe(map(function () { return new ChangePasswordSuccess(); }), catchError(function (error) { return of(new ChangePasswordFailure(error)); })); }));
        this.ChangePasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_SUCCESS), tap(function () { return _this.toastService.success(get(_this.traductions || {}, 'messages.changePasswordSuccess', 'Your password has been successfully changed!')); }));
        this.ChangePasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.changePasswordFailure', 'Wrong current password. Please try again.')); }));
        this.OpenForgottenPasswordDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_FORGOTTEN_PASSWORD_DIALOG), tap(function () { return _this.dialogRef = _this.dialog.open(ForgottenPasswordComponent); }));
        this.SendPassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD), tap(function () {
            _this.dialogRef.close();
        }), switchMap(function (action) { return _this.authService.sendPassword(action.payload).pipe(map(function () { return new SendPasswordSuccess(); }), catchError(function (error) { return of(new SendPasswordFailure(error)); })); }));
        this.SendPasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_SUCCESS), tap(function () { return _this.toastService.success(get(_this.traductions || {}, 'messages.passwordResetSuccess', 'An email for resetting your password has been sent to your address.')); }));
        this.SendPasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_FAILURE), tap(function () { return _this.toastService.error(get(_this.traductions || {}, 'messages.passwordResetFailure', 'An error occured. Please try again.')); }));
    }
    AuthEffects.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Inject, args: [AUTH_RESET_ACTIONS,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [AUTH_TRADUCTIONS,] }] },
        { type: Actions },
        { type: AuthService },
        { type: Router },
        { type: ToastrService },
        { type: MatDialog },
        { type: Store }
    ]; };
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "OpenSignUpDialog$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "SignUp$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SignUpSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SignUpFailure$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LogIn$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "LogInSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "LogInFailure$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LogOut$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LoadUserInformation$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "ChangePassword$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "ChangePasswordSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "ChangePasswordFailure$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "OpenForgottenPasswordDialog$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "SendPassword$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SendPasswordSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SendPasswordFailure$", void 0);
    AuthEffects = __decorate([
        Injectable(),
        __param(0, Inject(AUTH_RESET_ACTIONS)),
        __param(1, Inject(AUTH_TRADUCTIONS))
    ], AuthEffects);
    return AuthEffects;
}());
export { AuthEffects };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItYXV0aC1saWIvIiwic291cmNlcyI6WyJzdG9yZS9lZmZlY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFMUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1QyxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVGLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFN0IsT0FBTyxFQUNMLGlCQUFpQixFQUVqQixZQUFZLEVBQ1osWUFBWSxFQUdaLGFBQWEsRUFDYixhQUFhLEVBRWIscUJBQXFCLEVBQ3JCLHFCQUFxQixFQUNyQiwwQkFBMEIsRUFDMUIsMEJBQTBCLEVBRzFCLG1CQUFtQixFQUNuQixtQkFBbUIsRUFDcEIsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV6QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDdkQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sK0RBQStELENBQUM7QUFDM0csT0FB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TSxFQUFFO2dEQVFQO0lBR0Y7UUFEQyxNQUFNLEVBQUU7NkRBT1A7SUFHRjtRQURDLE1BQU0sRUFBRTt3REFPUDtJQUdGO1FBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDOytEQU0xQjtJQUdGO1FBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDOytEQU0xQjtJQUdGO1FBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDO3FFQUkxQjtJQUdGO1FBREMsTUFBTSxFQUFFO3NEQVVQO0lBR0Y7UUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7NkRBTTFCO0lBR0Y7UUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7NkRBTTFCO0lBdEtTLFdBQVc7UUFEdkIsVUFBVSxFQUFFO1FBS1IsV0FBQSxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtRQUMxQixXQUFBLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO09BTGhCLFdBQVcsQ0F1S3ZCO0lBQUQsa0JBQUM7Q0FBQSxBQXZLRCxJQXVLQztTQXZLWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQWN0aW9ucywgRWZmZWN0LCBvZlR5cGUgfSBmcm9tICdAbmdyeC9lZmZlY3RzJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFRvYXN0clNlcnZpY2UgfSBmcm9tICduZ3gtdG9hc3RyJztcbmltcG9ydCB7IFN0b3JlLCBzZWxlY3QgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBNYXREaWFsb2dSZWYsIE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgY2F0Y2hFcnJvciwgdGFwLCB3aXRoTGF0ZXN0RnJvbSwgY29uY2F0TWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQge1xuICBBVVRIX0FDVElPTlNfVFlQRSxcbiAgTG9nSW4sXG4gIExvZ0luU3VjY2VzcyxcbiAgTG9nSW5GYWlsdXJlLFxuICBMb2dPdXQsXG4gIFNpZ25VcCxcbiAgU2lnblVwRmFpbHVyZSxcbiAgU2lnblVwU3VjY2VzcyxcbiAgQ2hhbmdlUGFzc3dvcmQsXG4gIENoYW5nZVBhc3N3b3JkU3VjY2VzcyxcbiAgQ2hhbmdlUGFzc3dvcmRGYWlsdXJlLFxuICBMb2FkVXNlckluZm9ybWF0aW9uU3VjY2VzcyxcbiAgTG9hZFVzZXJJbmZvcm1hdGlvbkZhaWx1cmUsXG4gIExvYWRVc2VySW5mb3JtYXRpb24sXG4gIFNlbmRQYXNzd29yZCxcbiAgU2VuZFBhc3N3b3JkU3VjY2VzcyxcbiAgU2VuZFBhc3N3b3JkRmFpbHVyZVxufSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgc2VsZWN0VXNlciB9IGZyb20gJy4vc2VsZWN0b3JzJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9tb2RlbHMvdXNlci5tb2RlbHMnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2ZvcmdvdHRlbi1wYXNzd29yZC9mb3Jnb3R0ZW4tcGFzc3dvcmQuY29tcG9uZW50JztcbmltcG9ydCB7IEFVVEhfUkVTRVRfQUNUSU9OUywgQVVUSF9UUkFEVUNUSU9OUywgQXV0aE1vZHVsZUNvbmZpZyB9IGZyb20gJy4uL3Rva2VuJztcbmltcG9ydCB7IEF1dGhTdGF0ZSB9IGZyb20gJy4vcmVkdWNlcic7XG5pbXBvcnQgeyBTaWduVXBDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL3NpZ24tdXAvc2lnbi11cC5jb21wb25lbnQnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoRWZmZWN0cyB7XG4gIHByaXZhdGUgZGlhbG9nUmVmOiBNYXREaWFsb2dSZWY8U2lnblVwQ29tcG9uZW50IHwgRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoQVVUSF9SRVNFVF9BQ1RJT05TKSBwcml2YXRlIHJlc2V0QWN0aW9uczogYW55W10sXG4gICAgQEluamVjdChBVVRIX1RSQURVQ1RJT05TKSBwcml2YXRlIHRyYWR1Y3Rpb25zOiBBdXRoTW9kdWxlQ29uZmlnWyd0cmFkdWN0aW9ucyddLFxuICAgIHByaXZhdGUgYWN0aW9uczogQWN0aW9ucyxcbiAgICBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgdG9hc3RTZXJ2aWNlOiBUb2FzdHJTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGlhbG9nOiBNYXREaWFsb2csXG4gICAgcHJpdmF0ZSBzdG9yZTogU3RvcmU8QXV0aFN0YXRlPlxuICApIHsgfVxuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgT3BlblNpZ25VcERpYWxvZyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuT1BFTl9TSUdOX1VQX0RJQUxPRyksXG4gICAgdGFwKCgpID0+IHRoaXMuZGlhbG9nUmVmID0gdGhpcy5kaWFsb2cub3BlbihTaWduVXBDb21wb25lbnQpKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBTaWduVXAkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNJR05fVVApLFxuICAgIG1hcCgoYWN0aW9uOiBTaWduVXApID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHVzZXI6IFVzZXIpID0+IHRoaXMuYXV0aFNlcnZpY2UuY3JlYXRlVXNlcih1c2VyKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBTaWduVXBTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgU2lnblVwRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTaWduVXBTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TSUdOX1VQX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNpZ251cFN1Y2Nlc3MnLCAnWW91ciBhY2NvdW50IGhhcyBiZWVuIGNyZWF0ZWQhJylcbiAgICAgIClcbiAgICB9KVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2lnblVwRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0lHTl9VUF9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNpZ251cEZhaWx1cmUnLCAnUGxlYXNlIHRyeSBhZ2FpbiB3aXRoIGEgbmV3IHVzZXJuYW1lLicpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgTG9nSW4kID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTiksXG4gICAgbWFwKChhY3Rpb246IExvZ0luKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgc3dpdGNoTWFwKCh1c2VyOiBVc2VyKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmxvZ2luKHVzZXIpLnBpcGUoXG4gICAgICBjb25jYXRNYXAoKGxvZ2dlZEluVXNlcjogVXNlcikgPT4ge1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0b2tlbicsIGxvZ2dlZEluVXNlci50b2tlbi50b2tlbik7XG4gICAgICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlLmdldFVzZXJJbmZvcm1hdGlvbigpLnBpcGUoXG4gICAgICAgICAgbWFwKCh7dXNlciwgdXNlcnNMaXN0fSkgPT4gbmV3IExvZ0luU3VjY2Vzcyh7IHVzZXIsIHVzZXJzTGlzdCB9KSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9nSW5GYWlsdXJlKGVycm9yKSkpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IExvZ0luRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBMb2dJblN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTl9TVUNDRVNTKSxcbiAgICB3aXRoTGF0ZXN0RnJvbSh0aGlzLnN0b3JlLnBpcGUoc2VsZWN0KHNlbGVjdFVzZXIpKSksXG4gICAgdGFwKChbYWN0aW9uLCB1c2VyXTogW0xvZ0luU3VjY2VzcywgVXNlcl0pID0+IHtcbiAgICAgIGNvbnN0IHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgncmVkaXJlY3RlZFVybEFmdGVyTG9nSW4nKTtcbiAgICAgIGlmIChyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbikge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luKVxuICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybCh1c2VyLnJlZGlyZWN0VXJsQWZ0ZXJMb2dpbik7XG4gICAgICB9XG4gICAgICB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmxvZ2luU3VjY2VzcycsICdIaSEgTmljZSB0byBzZWUgeW91IGFnYWluIScpXG4gICAgICApO1xuICAgIH0pXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBMb2dJbkZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTl9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmxvZ2luRmFpbHVyZScsICdXcm9uZyBjcmVkZW50aWFscy4gUGxlYXNlIGNoZWNrIGFnYWluLicpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgTG9nT3V0JCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5MT0dfT1VUKSxcbiAgICBzd2l0Y2hNYXAoKGFjdGlvbjogTG9nT3V0KSA9PiB7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCd0b2tlbicpO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydsb2ctaW4nXSk7XG4gICAgICByZXR1cm4gKHRoaXMucmVzZXRBY3Rpb25zIHx8IFtdKS5tYXAoKHJlc2V0QWN0aW9uOiBhbnkpID0+IG5ldyByZXNldEFjdGlvbigpKVxuICAgIH0pXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIExvYWRVc2VySW5mb3JtYXRpb24kID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPQURfVVNFUl9JTkZPUk1BVElPTiksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IExvYWRVc2VySW5mb3JtYXRpb24pID0+IHRoaXMuYXV0aFNlcnZpY2UuZ2V0VXNlckluZm9ybWF0aW9uKCkucGlwZShcbiAgICAgIG1hcCgoe3VzZXIsIHVzZXJzTGlzdH0pID0+IG5ldyBMb2FkVXNlckluZm9ybWF0aW9uU3VjY2Vzcyh1c2VyKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBMb2FkVXNlckluZm9ybWF0aW9uRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIENoYW5nZVBhc3N3b3JkJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5DSEFOR0VfUEFTU1dPUkQpLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBDaGFuZ2VQYXNzd29yZCkgPT4gdGhpcy5hdXRoU2VydmljZS5jaGFuZ2VQYXNzd29yZChhY3Rpb24ucGF5bG9hZCkucGlwZShcbiAgICAgIG1hcCgoKSA9PiBuZXcgQ2hhbmdlUGFzc3dvcmRTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgQ2hhbmdlUGFzc3dvcmRGYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIENoYW5nZVBhc3N3b3JkU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuQ0hBTkdFX1BBU1NXT1JEX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5jaGFuZ2VQYXNzd29yZFN1Y2Nlc3MnLCAnWW91ciBwYXNzd29yZCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgY2hhbmdlZCEnKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBDaGFuZ2VQYXNzd29yZEZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkNIQU5HRV9QQVNTV09SRF9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmNoYW5nZVBhc3N3b3JkRmFpbHVyZScsICdXcm9uZyBjdXJyZW50IHBhc3N3b3JkLiBQbGVhc2UgdHJ5IGFnYWluLicpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIE9wZW5Gb3Jnb3R0ZW5QYXNzd29yZERpYWxvZyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuT1BFTl9GT1JHT1RURU5fUEFTU1dPUkRfRElBTE9HKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5kaWFsb2dSZWYgPSB0aGlzLmRpYWxvZy5vcGVuKEZvcmdvdHRlblBhc3N3b3JkQ29tcG9uZW50KSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgU2VuZFBhc3N3b3JkJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TRU5EX1BBU1NXT1JEKSxcbiAgICB0YXAoKCkgPT4ge1xuICAgICAgdGhpcy5kaWFsb2dSZWYuY2xvc2UoKTtcbiAgICB9KSxcbiAgICBzd2l0Y2hNYXAoKGFjdGlvbjogU2VuZFBhc3N3b3JkKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLnNlbmRQYXNzd29yZChhY3Rpb24ucGF5bG9hZCkucGlwZShcbiAgICAgIG1hcCgoKSA9PiBuZXcgU2VuZFBhc3N3b3JkU3VjY2VzcygpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IFNlbmRQYXNzd29yZEZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2VuZFBhc3N3b3JkU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9QQVNTV09SRF9TVUNDRVNTKSxcbiAgICB0YXAoKCkgPT4gdGhpcy50b2FzdFNlcnZpY2Uuc3VjY2VzcyhcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMucGFzc3dvcmRSZXNldFN1Y2Nlc3MnLCAnQW4gZW1haWwgZm9yIHJlc2V0dGluZyB5b3VyIHBhc3N3b3JkIGhhcyBiZWVuIHNlbnQgdG8geW91ciBhZGRyZXNzLicpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNlbmRQYXNzd29yZEZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfUEFTU1dPUkRfRkFJTFVSRSksXG4gICAgdGFwKCgpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5wYXNzd29yZFJlc2V0RmFpbHVyZScsICdBbiBlcnJvciBvY2N1cmVkLiBQbGVhc2UgdHJ5IGFnYWluLicpXG4gICAgKSlcbiAgKTtcbn1cbiJdfQ==