import { __decorate, __param, __read } from "tslib";
import { Injectable, Inject, PLATFORM_ID } from '@angular/core';
import { Router } from '@angular/router';
import { Actions, Effect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { ToastrService } from 'ngx-toastr';
import { Store, select } from '@ngrx/store';
import { MatDialogRef, MatDialog } from '@angular/material/dialog';
import { map, switchMap, catchError, tap, withLatestFrom, concatMap, filter } from 'rxjs/operators';
import get from 'lodash-es/get';
import { AUTH_ACTIONS_TYPE, LogInSuccess, LogInFailure, SignUpFailure, SignUpSuccess, ChangePasswordSuccess, ChangePasswordFailure, LoadUserInformationSuccess, LoadUserInformationFailure, SendPasswordSuccess, SendPasswordFailure } from './actions';
import { selectUser } from './selectors';
import { AuthService } from '../services/auth.service';
import { ForgottenPasswordComponent } from '../components/forgotten-password/forgotten-password.component';
import { AUTH_RESET_ACTIONS, AUTH_TRADUCTIONS } from '../token';
import { SignUpComponent } from '../components/sign-up/sign-up.component';
import { isPlatformBrowser } from '@angular/common';
var AuthEffects = /** @class */ (function () {
    function AuthEffects(resetActions, traductions, platformId, actions, authService, router, toastService, dialog, store) {
        var _this = this;
        this.resetActions = resetActions;
        this.traductions = traductions;
        this.platformId = platformId;
        this.actions = actions;
        this.authService = authService;
        this.router = router;
        this.toastService = toastService;
        this.dialog = dialog;
        this.store = store;
        this.OpenSignUpDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_SIGN_UP_DIALOG), tap(function () { return _this.dialogRef = _this.dialog.open(SignUpComponent); }));
        this.SignUp$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP), map(function (action) { return action.payload; }), switchMap(function (user) { return _this.authService.createUser(user).pipe(map(function () { return new SignUpSuccess(); }), catchError(function (error) { return of(new SignUpFailure(error)); })); }));
        this.SignUpSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_SUCCESS), tap(function () {
            _this.toastService.success(get(_this.traductions || {}, 'messages.signupSuccess', 'Your account has been created!'));
        }));
        this.SignUpFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.signupFailure', 'Please try again with a new username.')); }));
        this.LogIn$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN), filter(function (action) { return isPlatformBrowser(_this.platformId); }), map(function (action) { return action.payload; }), switchMap(function (user) { return _this.authService.login(user).pipe(concatMap(function (loggedInUser) {
            sessionStorage.setItem('token', loggedInUser.token.token);
            return _this.authService.getUserInformation().pipe(map(function (_a) {
                var user = _a.user, usersList = _a.usersList;
                return new LogInSuccess({ user: user, usersList: usersList });
            }), catchError(function (error) { return of(new LogInFailure(error)); }));
        }), catchError(function (error) { return of(new LogInFailure(error)); })); }));
        this.LogInSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_SUCCESS), filter(function (action) { return isPlatformBrowser(_this.platformId); }), withLatestFrom(this.store.pipe(select(selectUser))), tap(function (_a) {
            var _b = __read(_a, 2), action = _b[0], user = _b[1];
            var redirectedUrlAfterLogIn = sessionStorage.getItem('redirectedUrlAfterLogIn');
            if (redirectedUrlAfterLogIn && isPlatformBrowser(_this.platformId)) {
                _this.router.navigateByUrl(redirectedUrlAfterLogIn);
                sessionStorage.removeItem('redirectedUrlAfterLogIn');
            }
            else {
                _this.router.navigateByUrl(user.redirectUrlAfterLogin);
            }
            _this.toastService.success(get(_this.traductions || {}, 'messages.loginSuccess', 'Hi! Nice to see you again!'));
        }));
        this.LogInFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.loginFailure', 'Wrong credentials. Please check again.')); }));
        this.LogOut$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_OUT), filter(function (action) { return isPlatformBrowser(_this.platformId); }), switchMap(function (action) {
            sessionStorage.removeItem('token');
            _this.router.navigate(['log-in']);
            return (_this.resetActions || []).map(function (resetAction) { return new resetAction(); });
        }));
        this.LoadUserInformation$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOAD_USER_INFORMATION), switchMap(function (action) { return _this.authService.getUserInformation().pipe(map(function (_a) {
            var user = _a.user, usersList = _a.usersList;
            return new LoadUserInformationSuccess(user);
        }), catchError(function (error) { return of(new LoadUserInformationFailure(error)); })); }));
        this.ChangePassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD), switchMap(function (action) { return _this.authService.changePassword(action.payload).pipe(map(function () { return new ChangePasswordSuccess(); }), catchError(function (error) { return of(new ChangePasswordFailure(error)); })); }));
        this.ChangePasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_SUCCESS), tap(function () { return _this.toastService.success(get(_this.traductions || {}, 'messages.changePasswordSuccess', 'Your password has been successfully changed!')); }));
        this.ChangePasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_FAILURE), tap(function (error) { return _this.toastService.error(get(_this.traductions || {}, 'messages.changePasswordFailure', 'Wrong current password. Please try again.')); }));
        this.OpenForgottenPasswordDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_FORGOTTEN_PASSWORD_DIALOG), tap(function () { return _this.dialogRef = _this.dialog.open(ForgottenPasswordComponent); }));
        this.SendPassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD), tap(function () {
            _this.dialogRef.close();
        }), switchMap(function (action) { return _this.authService.sendPassword(action.payload).pipe(map(function () { return new SendPasswordSuccess(); }), catchError(function (error) { return of(new SendPasswordFailure(error)); })); }));
        this.SendPasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_SUCCESS), tap(function () { return _this.toastService.success(get(_this.traductions || {}, 'messages.passwordResetSuccess', 'An email for resetting your password has been sent to your address.')); }));
        this.SendPasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_FAILURE), tap(function () { return _this.toastService.error(get(_this.traductions || {}, 'messages.passwordResetFailure', 'An error occured. Please try again.')); }));
    }
    AuthEffects.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Inject, args: [AUTH_RESET_ACTIONS,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [AUTH_TRADUCTIONS,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
        { type: Actions },
        { type: AuthService },
        { type: Router },
        { type: ToastrService },
        { type: MatDialog },
        { type: Store }
    ]; };
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "OpenSignUpDialog$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "SignUp$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SignUpSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SignUpFailure$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LogIn$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "LogInSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "LogInFailure$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LogOut$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "LoadUserInformation$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "ChangePassword$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "ChangePasswordSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "ChangePasswordFailure$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "OpenForgottenPasswordDialog$", void 0);
    __decorate([
        Effect()
    ], AuthEffects.prototype, "SendPassword$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SendPasswordSuccess$", void 0);
    __decorate([
        Effect({ dispatch: false })
    ], AuthEffects.prototype, "SendPasswordFailure$", void 0);
    AuthEffects = __decorate([
        Injectable(),
        __param(0, Inject(AUTH_RESET_ACTIONS)),
        __param(1, Inject(AUTH_TRADUCTIONS)),
        __param(2, Inject(PLATFORM_ID))
    ], AuthEffects);
    return AuthEffects;
}());
export { AuthEffects };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItYXV0aC1saWIvIiwic291cmNlcyI6WyJzdG9yZS9lZmZlY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEcsT0FBTyxHQUFHLE1BQU0sZUFBZSxDQUFDO0FBRWhDLE9BQU8sRUFDTCxpQkFBaUIsRUFFakIsWUFBWSxFQUNaLFlBQVksRUFHWixhQUFhLEVBQ2IsYUFBYSxFQUViLHFCQUFxQixFQUNyQixxQkFBcUIsRUFDckIsMEJBQTBCLEVBQzFCLDBCQUEwQixFQUcxQixtQkFBbUIsRUFDbkIsbUJBQW1CLEVBQ3BCLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFekMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLCtEQUErRCxDQUFD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LENBQUMsV0FBVyxDQUFDLENBQUE7T0FOWCxXQUFXLENBMkt2QjtJQUFELGtCQUFDO0NBQUEsQUEzS0QsSUEyS0M7U0EzS1ksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBY3Rpb25zLCBFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgVG9hc3RyU2VydmljZSB9IGZyb20gJ25neC10b2FzdHInO1xuaW1wb3J0IHsgU3RvcmUsIHNlbGVjdCB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7IE1hdERpYWxvZ1JlZiwgTWF0RGlhbG9nIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGlhbG9nJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCBjYXRjaEVycm9yLCB0YXAsIHdpdGhMYXRlc3RGcm9tLCBjb25jYXRNYXAsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IGdldCBmcm9tICdsb2Rhc2gtZXMvZ2V0JztcblxuaW1wb3J0IHtcbiAgQVVUSF9BQ1RJT05TX1RZUEUsXG4gIExvZ0luLFxuICBMb2dJblN1Y2Nlc3MsXG4gIExvZ0luRmFpbHVyZSxcbiAgTG9nT3V0LFxuICBTaWduVXAsXG4gIFNpZ25VcEZhaWx1cmUsXG4gIFNpZ25VcFN1Y2Nlc3MsXG4gIENoYW5nZVBhc3N3b3JkLFxuICBDaGFuZ2VQYXNzd29yZFN1Y2Nlc3MsXG4gIENoYW5nZVBhc3N3b3JkRmFpbHVyZSxcbiAgTG9hZFVzZXJJbmZvcm1hdGlvblN1Y2Nlc3MsXG4gIExvYWRVc2VySW5mb3JtYXRpb25GYWlsdXJlLFxuICBMb2FkVXNlckluZm9ybWF0aW9uLFxuICBTZW5kUGFzc3dvcmQsXG4gIFNlbmRQYXNzd29yZFN1Y2Nlc3MsXG4gIFNlbmRQYXNzd29yZEZhaWx1cmVcbn0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IHNlbGVjdFVzZXIgfSBmcm9tICcuL3NlbGVjdG9ycyc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL3VzZXIubW9kZWxzJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcmdvdHRlblBhc3N3b3JkQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3Jnb3R0ZW4tcGFzc3dvcmQvZm9yZ290dGVuLXBhc3N3b3JkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBVVRIX1JFU0VUX0FDVElPTlMsIEFVVEhfVFJBRFVDVElPTlMsIEF1dGhNb2R1bGVDb25maWcgfSBmcm9tICcuLi90b2tlbic7XG5pbXBvcnQgeyBBdXRoU3RhdGUgfSBmcm9tICcuL3JlZHVjZXInO1xuaW1wb3J0IHsgU2lnblVwQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9zaWduLXVwL3NpZ24tdXAuY29tcG9uZW50JztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aEVmZmVjdHMge1xuICBwcml2YXRlIGRpYWxvZ1JlZjogTWF0RGlhbG9nUmVmPFNpZ25VcENvbXBvbmVudCB8IEZvcmdvdHRlblBhc3N3b3JkQ29tcG9uZW50PjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEFVVEhfUkVTRVRfQUNUSU9OUykgcHJpdmF0ZSByZXNldEFjdGlvbnM6IGFueVtdLFxuICAgIEBJbmplY3QoQVVUSF9UUkFEVUNUSU9OUykgcHJpdmF0ZSB0cmFkdWN0aW9uczogQXV0aE1vZHVsZUNvbmZpZ1sndHJhZHVjdGlvbnMnXSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IGFueSxcbiAgICBwcml2YXRlIGFjdGlvbnM6IEFjdGlvbnMsXG4gICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHRvYXN0U2VydmljZTogVG9hc3RyU2VydmljZSxcbiAgICBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgIHByaXZhdGUgc3RvcmU6IFN0b3JlPEF1dGhTdGF0ZT5cbiAgKSB7IH1cblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIE9wZW5TaWduVXBEaWFsb2ckID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLk9QRU5fU0lHTl9VUF9ESUFMT0cpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmRpYWxvZ1JlZiA9IHRoaXMuZGlhbG9nLm9wZW4oU2lnblVwQ29tcG9uZW50KSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgU2lnblVwJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TSUdOX1VQKSxcbiAgICBtYXAoKGFjdGlvbjogU2lnblVwKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgc3dpdGNoTWFwKCh1c2VyOiBVc2VyKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZVVzZXIodXNlcikucGlwZShcbiAgICAgIG1hcCgoKSA9PiBuZXcgU2lnblVwU3VjY2VzcygpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IFNpZ25VcEZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2lnblVwU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0lHTl9VUF9TVUNDRVNTKSxcbiAgICB0YXAoKCkgPT4ge1xuICAgICAgdGhpcy50b2FzdFNlcnZpY2Uuc3VjY2VzcyhcbiAgICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5zaWdudXBTdWNjZXNzJywgJ1lvdXIgYWNjb3VudCBoYXMgYmVlbiBjcmVhdGVkIScpXG4gICAgICApXG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNpZ25VcEZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNJR05fVVBfRkFJTFVSRSksXG4gICAgdGFwKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5zaWdudXBGYWlsdXJlJywgJ1BsZWFzZSB0cnkgYWdhaW4gd2l0aCBhIG5ldyB1c2VybmFtZS4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIExvZ0luJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5MT0dfSU4pLFxuICAgIGZpbHRlcigoYWN0aW9uOiBMb2dJbikgPT4gaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSksXG4gICAgbWFwKChhY3Rpb246IExvZ0luKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgc3dpdGNoTWFwKCh1c2VyOiBVc2VyKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmxvZ2luKHVzZXIpLnBpcGUoXG4gICAgICBjb25jYXRNYXAoKGxvZ2dlZEluVXNlcjogVXNlcikgPT4ge1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd0b2tlbicsIGxvZ2dlZEluVXNlci50b2tlbi50b2tlbik7XG4gICAgICAgIHJldHVybiB0aGlzLmF1dGhTZXJ2aWNlLmdldFVzZXJJbmZvcm1hdGlvbigpLnBpcGUoXG4gICAgICAgICAgbWFwKCh7dXNlciwgdXNlcnNMaXN0fSkgPT4gbmV3IExvZ0luU3VjY2Vzcyh7IHVzZXIsIHVzZXJzTGlzdCB9KSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9nSW5GYWlsdXJlKGVycm9yKSkpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IExvZ0luRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBMb2dJblN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTl9TVUNDRVNTKSxcbiAgICBmaWx0ZXIoKGFjdGlvbjogTG9nSW5TdWNjZXNzKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSxcbiAgICB3aXRoTGF0ZXN0RnJvbSh0aGlzLnN0b3JlLnBpcGUoc2VsZWN0KHNlbGVjdFVzZXIpKSksXG4gICAgdGFwKChbYWN0aW9uLCB1c2VyXTogW0xvZ0luU3VjY2VzcywgVXNlcl0pID0+IHtcbiAgICAgIGNvbnN0IHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgncmVkaXJlY3RlZFVybEFmdGVyTG9nSW4nKTtcbiAgICAgIGlmIChyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbiAmJiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwocmVkaXJlY3RlZFVybEFmdGVyTG9nSW4pXG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3JlZGlyZWN0ZWRVcmxBZnRlckxvZ0luJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVzZXIucmVkaXJlY3RVcmxBZnRlckxvZ2luKTtcbiAgICAgIH1cbiAgICAgIHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMubG9naW5TdWNjZXNzJywgJ0hpISBOaWNlIHRvIHNlZSB5b3UgYWdhaW4hJylcbiAgICAgICk7XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIExvZ0luRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOX0ZBSUxVUkUpLFxuICAgIHRhcCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMubG9naW5GYWlsdXJlJywgJ1dyb25nIGNyZWRlbnRpYWxzLiBQbGVhc2UgY2hlY2sgYWdhaW4uJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2dPdXQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19PVVQpLFxuICAgIGZpbHRlcigoYWN0aW9uOiBMb2dPdXQpID0+IGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBMb2dPdXQpID0+IHtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3Rva2VuJyk7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ2xvZy1pbiddKTtcbiAgICAgIHJldHVybiAodGhpcy5yZXNldEFjdGlvbnMgfHwgW10pLm1hcCgocmVzZXRBY3Rpb246IGFueSkgPT4gbmV3IHJlc2V0QWN0aW9uKCkpXG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgTG9hZFVzZXJJbmZvcm1hdGlvbiQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9BRF9VU0VSX0lORk9STUFUSU9OKSxcbiAgICBzd2l0Y2hNYXAoKGFjdGlvbjogTG9hZFVzZXJJbmZvcm1hdGlvbikgPT4gdGhpcy5hdXRoU2VydmljZS5nZXRVc2VySW5mb3JtYXRpb24oKS5waXBlKFxuICAgICAgbWFwKCh7dXNlciwgdXNlcnNMaXN0fSkgPT4gbmV3IExvYWRVc2VySW5mb3JtYXRpb25TdWNjZXNzKHVzZXIpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IExvYWRVc2VySW5mb3JtYXRpb25GYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgQ2hhbmdlUGFzc3dvcmQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkNIQU5HRV9QQVNTV09SRCksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IENoYW5nZVBhc3N3b3JkKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmNoYW5nZVBhc3N3b3JkKGFjdGlvbi5wYXlsb2FkKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBDaGFuZ2VQYXNzd29yZFN1Y2Nlc3MoKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBDaGFuZ2VQYXNzd29yZEZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgQ2hhbmdlUGFzc3dvcmRTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5DSEFOR0VfUEFTU1dPUkRfU1VDQ0VTUyksXG4gICAgdGFwKCgpID0+IHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmNoYW5nZVBhc3N3b3JkU3VjY2VzcycsICdZb3VyIHBhc3N3b3JkIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBjaGFuZ2VkIScpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIENoYW5nZVBhc3N3b3JkRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuQ0hBTkdFX1BBU1NXT1JEX0ZBSUxVUkUpLFxuICAgIHRhcCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMuY2hhbmdlUGFzc3dvcmRGYWlsdXJlJywgJ1dyb25nIGN1cnJlbnQgcGFzc3dvcmQuIFBsZWFzZSB0cnkgYWdhaW4uJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgT3BlbkZvcmdvdHRlblBhc3N3b3JkRGlhbG9nJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5PUEVOX0ZPUkdPVFRFTl9QQVNTV09SRF9ESUFMT0cpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmRpYWxvZ1JlZiA9IHRoaXMuZGlhbG9nLm9wZW4oRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQpKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBTZW5kUGFzc3dvcmQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfUEFTU1dPUkQpLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgIH0pLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBTZW5kUGFzc3dvcmQpID0+IHRoaXMuYXV0aFNlcnZpY2Uuc2VuZFBhc3N3b3JkKGFjdGlvbi5wYXlsb2FkKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBTZW5kUGFzc3dvcmRTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgU2VuZFBhc3N3b3JkRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTZW5kUGFzc3dvcmRTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TRU5EX1BBU1NXT1JEX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5wYXNzd29yZFJlc2V0U3VjY2VzcycsICdBbiBlbWFpbCBmb3IgcmVzZXR0aW5nIHlvdXIgcGFzc3dvcmQgaGFzIGJlZW4gc2VudCB0byB5b3VyIGFkZHJlc3MuJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2VuZFBhc3N3b3JkRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9QQVNTV09SRF9GQUlMVVJFKSxcbiAgICB0YXAoKCkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnBhc3N3b3JkUmVzZXRGYWlsdXJlJywgJ0FuIGVycm9yIG9jY3VyZWQuIFBsZWFzZSB0cnkgYWdhaW4uJylcbiAgICApKVxuICApO1xufVxuIl19