import { __decorate, __param } from "tslib";
import { Injectable, Inject, PLATFORM_ID } from '@angular/core';
import { Router } from '@angular/router';
import { Actions, Effect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { ToastrService } from 'ngx-toastr';
import { Store, select } from '@ngrx/store';
import { MatDialogRef, MatDialog } from '@angular/material/dialog';
import { map, switchMap, catchError, tap, withLatestFrom, concatMap, filter } from 'rxjs/operators';
import { get } from '../utils';
import { AUTH_ACTIONS_TYPE, LogInSuccess, LogInFailure, SignUpFailure, SignUpSuccess, ChangePasswordSuccess, ChangePasswordFailure, LoadUserInformationSuccess, LoadUserInformationFailure, SendPasswordSuccess, SendPasswordFailure, SendActivationCodeSuccess, SendActivationCodeFailure, ResetAuthState } from './actions';
import { selectUser } from './selectors';
import { AuthService } from '../services/auth.service';
import { ForgottenPasswordComponent } from '../components/forgotten-password/forgotten-password.component';
import { AUTH_RESET_ACTIONS, AUTH_TRADUCTIONS } from '../token';
import { SignUpComponent } from '../components/sign-up/sign-up.component';
import { isPlatformBrowser } from '@angular/common';
let AuthEffects = class AuthEffects {
    constructor(resetActions, traductions, platformId, actions, authService, router, toastService, dialog, store) {
        this.resetActions = resetActions;
        this.traductions = traductions;
        this.platformId = platformId;
        this.actions = actions;
        this.authService = authService;
        this.router = router;
        this.toastService = toastService;
        this.dialog = dialog;
        this.store = store;
        this.OpenSignUpDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_SIGN_UP_DIALOG), tap(() => this.dialogRef = this.dialog.open(SignUpComponent)));
        this.SignUp$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP), map((action) => action.payload), switchMap((user) => this.authService.createUser(user).pipe(map(() => new SignUpSuccess()), catchError((error) => of(new SignUpFailure(error))))));
        this.SignUpSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_SUCCESS), tap(() => {
            this.toastService.success(get(this.traductions || {}, 'messages.signupSuccess', 'Your account has been created!'));
            if (this.dialogRef) {
                this.dialogRef.close();
            }
        }));
        this.SignUpFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_FAILURE), map((action) => action.payload), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.signupFailure', 'Please try again.'))));
        this.SendActivationCode$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_ACTIVATION_CODE), map((action) => action.payload), switchMap((activationCode) => this.authService.sendActivationCode(activationCode).pipe(map(() => new SendActivationCodeSuccess()), catchError((error) => of(new SendActivationCodeFailure(error))))));
        this.SendActivationCodeSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_ACTIVATION_CODE_SUCCESS), tap(() => {
            this.toastService.success(get(this.traductions || {}, 'messages.sendActivationCodeSuccess', 'Your account has been verified!'));
            this.router.navigate(['log-in']);
        }), map(() => new ResetAuthState()));
        this.SendActivationCodeFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_ACTIVATION_CODE_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.sendActivationCodeFailure', 'Please try again with the correct code.'))));
        this.LogIn$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN), filter((action) => isPlatformBrowser(this.platformId)), map((action) => action.payload), switchMap((user) => this.authService.login(user).pipe(concatMap((loggedInUser) => {
            sessionStorage.setItem('token', loggedInUser.token.token);
            return this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LogInSuccess({ user, usersList })), catchError((error) => of(new LogInFailure(error))));
        }), catchError((error) => of(new LogInFailure(error))))));
        this.LogInSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_SUCCESS), filter((action) => isPlatformBrowser(this.platformId)), withLatestFrom(this.store.pipe(select(selectUser))), tap(([action, user]) => {
            const redirectedUrlAfterLogIn = sessionStorage.getItem('redirectedUrlAfterLogIn');
            if (redirectedUrlAfterLogIn && isPlatformBrowser(this.platformId)) {
                this.router.navigateByUrl(redirectedUrlAfterLogIn);
                sessionStorage.removeItem('redirectedUrlAfterLogIn');
            }
            else {
                this.router.navigateByUrl(user.redirectUrlAfterLogin);
            }
            this.toastService.success(get(this.traductions || {}, 'messages.loginSuccess', 'Hi! Nice to see you again!'));
        }));
        this.LogInFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.loginFailure', 'Wrong credentials. Please check again.'))));
        this.LogOut$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_OUT), filter((action) => isPlatformBrowser(this.platformId)), switchMap((action) => {
            sessionStorage.removeItem('token');
            this.router.navigate(['log-in']);
            return (this.resetActions || []).map((resetAction) => new resetAction());
        }));
        this.LoadUserInformation$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOAD_USER_INFORMATION), switchMap((action) => this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LoadUserInformationSuccess(user)), catchError((error) => of(new LoadUserInformationFailure(error))))));
        this.ChangePassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD), switchMap((action) => this.authService.changePassword(action.payload).pipe(map(() => new ChangePasswordSuccess()), catchError((error) => of(new ChangePasswordFailure(error))))));
        this.ChangePasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.changePasswordSuccess', 'Your password has been successfully changed!'))));
        this.ChangePasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.changePasswordFailure', 'Wrong current password. Please try again.'))));
        this.OpenForgottenPasswordDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_FORGOTTEN_PASSWORD_DIALOG), tap(() => this.dialogRef = this.dialog.open(ForgottenPasswordComponent)));
        this.SendPassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD), tap(() => {
            this.dialogRef.close();
        }), switchMap((action) => this.authService.sendPassword(action.payload).pipe(map(() => new SendPasswordSuccess()), catchError((error) => of(new SendPasswordFailure(error))))));
        this.SendPasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.passwordResetSuccess', 'An email for resetting your password has been sent to your address.'))));
        this.SendPasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_FAILURE), tap(() => this.toastService.error(get(this.traductions || {}, 'messages.passwordResetFailure', 'An error occured. Please try again.'))));
    }
};
AuthEffects.ctorParameters = () => [
    { type: Array, decorators: [{ type: Inject, args: [AUTH_RESET_ACTIONS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [AUTH_TRADUCTIONS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: Actions },
    { type: AuthService },
    { type: Router },
    { type: ToastrService },
    { type: MatDialog },
    { type: Store }
];
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenSignUpDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SignUp$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SendActivationCode$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SendActivationCodeSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendActivationCodeFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogIn$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogOut$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LoadUserInformation$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "ChangePassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordFailure$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenForgottenPasswordDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SendPassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordFailure$", void 0);
AuthEffects = __decorate([
    Injectable(),
    __param(0, Inject(AUTH_RESET_ACTIONS)),
    __param(1, Inject(AUTH_TRADUCTIONS)),
    __param(2, Inject(PLATFORM_ID))
], AuthEffects);
export { AuthEffects };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItYXV0aC1saWIvIiwic291cmNlcyI6WyJzdG9yZS9lZmZlY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEcsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUvQixPQUFPLEVBQ0wsaUJBQWlCLEVBRWpCLFlBQVksRUFDWixZQUFZLEVBR1osYUFBYSxFQUNiLGFBQWEsRUFFYixxQkFBcUIsRUFDckIscUJBQXFCLEVBQ3JCLDBCQUEwQixFQUMxQiwwQkFBMEIsRUFHMUIsbUJBQW1CLEVBQ25CLG1CQUFtQixFQUVuQix5QkFBeUIsRUFDekIseUJBQXlCLEVBQ3pCLGNBQWMsRUFDZixNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXpDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FB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O0lBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDO3lEQU0xQjtBQUdGO0lBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDO3lEQU0xQjtBQTVNUyxXQUFXO0lBRHZCLFVBQVUsRUFBRTtJQUtSLFdBQUEsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDMUIsV0FBQSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtJQUN4QixXQUFBLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtHQU5YLFdBQVcsQ0E2TXZCO1NBN01ZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQWN0aW9ucywgRWZmZWN0LCBvZlR5cGUgfSBmcm9tICdAbmdyeC9lZmZlY3RzJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFRvYXN0clNlcnZpY2UgfSBmcm9tICduZ3gtdG9hc3RyJztcbmltcG9ydCB7IFN0b3JlLCBzZWxlY3QgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBNYXREaWFsb2dSZWYsIE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgY2F0Y2hFcnJvciwgdGFwLCB3aXRoTGF0ZXN0RnJvbSwgY29uY2F0TWFwLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGdldCB9IGZyb20gJy4uL3V0aWxzJztcblxuaW1wb3J0IHtcbiAgQVVUSF9BQ1RJT05TX1RZUEUsXG4gIExvZ0luLFxuICBMb2dJblN1Y2Nlc3MsXG4gIExvZ0luRmFpbHVyZSxcbiAgTG9nT3V0LFxuICBTaWduVXAsXG4gIFNpZ25VcEZhaWx1cmUsXG4gIFNpZ25VcFN1Y2Nlc3MsXG4gIENoYW5nZVBhc3N3b3JkLFxuICBDaGFuZ2VQYXNzd29yZFN1Y2Nlc3MsXG4gIENoYW5nZVBhc3N3b3JkRmFpbHVyZSxcbiAgTG9hZFVzZXJJbmZvcm1hdGlvblN1Y2Nlc3MsXG4gIExvYWRVc2VySW5mb3JtYXRpb25GYWlsdXJlLFxuICBMb2FkVXNlckluZm9ybWF0aW9uLFxuICBTZW5kUGFzc3dvcmQsXG4gIFNlbmRQYXNzd29yZFN1Y2Nlc3MsXG4gIFNlbmRQYXNzd29yZEZhaWx1cmUsXG4gIFNlbmRBY3RpdmF0aW9uQ29kZSxcbiAgU2VuZEFjdGl2YXRpb25Db2RlU3VjY2VzcyxcbiAgU2VuZEFjdGl2YXRpb25Db2RlRmFpbHVyZSxcbiAgUmVzZXRBdXRoU3RhdGVcbn0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IHNlbGVjdFVzZXIgfSBmcm9tICcuL3NlbGVjdG9ycyc7XG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL3VzZXIubW9kZWxzJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcmdvdHRlblBhc3N3b3JkQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3Jnb3R0ZW4tcGFzc3dvcmQvZm9yZ290dGVuLXBhc3N3b3JkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBVVRIX1JFU0VUX0FDVElPTlMsIEFVVEhfVFJBRFVDVElPTlMsIEF1dGhNb2R1bGVDb25maWcgfSBmcm9tICcuLi90b2tlbic7XG5pbXBvcnQgeyBBdXRoU3RhdGUgfSBmcm9tICcuL3JlZHVjZXInO1xuaW1wb3J0IHsgU2lnblVwQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9zaWduLXVwL3NpZ24tdXAuY29tcG9uZW50JztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aEVmZmVjdHMge1xuICBwcml2YXRlIGRpYWxvZ1JlZjogTWF0RGlhbG9nUmVmPFNpZ25VcENvbXBvbmVudCB8IEZvcmdvdHRlblBhc3N3b3JkQ29tcG9uZW50PjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEFVVEhfUkVTRVRfQUNUSU9OUykgcHJpdmF0ZSByZXNldEFjdGlvbnM6IGFueVtdLFxuICAgIEBJbmplY3QoQVVUSF9UUkFEVUNUSU9OUykgcHJpdmF0ZSB0cmFkdWN0aW9uczogQXV0aE1vZHVsZUNvbmZpZ1sndHJhZHVjdGlvbnMnXSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IGFueSxcbiAgICBwcml2YXRlIGFjdGlvbnM6IEFjdGlvbnMsXG4gICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHRvYXN0U2VydmljZTogVG9hc3RyU2VydmljZSxcbiAgICBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgIHByaXZhdGUgc3RvcmU6IFN0b3JlPEF1dGhTdGF0ZT5cbiAgKSB7IH1cblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIE9wZW5TaWduVXBEaWFsb2ckID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLk9QRU5fU0lHTl9VUF9ESUFMT0cpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmRpYWxvZ1JlZiA9IHRoaXMuZGlhbG9nLm9wZW4oU2lnblVwQ29tcG9uZW50KSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgU2lnblVwJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TSUdOX1VQKSxcbiAgICBtYXAoKGFjdGlvbjogU2lnblVwKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgc3dpdGNoTWFwKCh1c2VyOiBVc2VyKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZVVzZXIodXNlcikucGlwZShcbiAgICAgIG1hcCgoKSA9PiBuZXcgU2lnblVwU3VjY2VzcygpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IFNpZ25VcEZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2lnblVwU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0lHTl9VUF9TVUNDRVNTKSxcbiAgICB0YXAoKCkgPT4ge1xuICAgICAgdGhpcy50b2FzdFNlcnZpY2Uuc3VjY2VzcyhcbiAgICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5zaWdudXBTdWNjZXNzJywgJ1lvdXIgYWNjb3VudCBoYXMgYmVlbiBjcmVhdGVkIScpXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuZGlhbG9nUmVmKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNpZ25VcEZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNJR05fVVBfRkFJTFVSRSksXG4gICAgbWFwKChhY3Rpb246IFNpZ25VcEZhaWx1cmUpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICB0YXAoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNpZ251cEZhaWx1cmUnLCAnUGxlYXNlIHRyeSBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIFNlbmRBY3RpdmF0aW9uQ29kZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9BQ1RJVkFUSU9OX0NPREUpLFxuICAgIG1hcCgoYWN0aW9uOiBTZW5kQWN0aXZhdGlvbkNvZGUpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKGFjdGl2YXRpb25Db2RlOiBzdHJpbmcpID0+IHRoaXMuYXV0aFNlcnZpY2Uuc2VuZEFjdGl2YXRpb25Db2RlKGFjdGl2YXRpb25Db2RlKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBTZW5kQWN0aXZhdGlvbkNvZGVTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgU2VuZEFjdGl2YXRpb25Db2RlRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIFNlbmRBY3RpdmF0aW9uQ29kZVN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfQUNUSVZBVElPTl9DT0RFX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNlbmRBY3RpdmF0aW9uQ29kZVN1Y2Nlc3MnLCAnWW91ciBhY2NvdW50IGhhcyBiZWVuIHZlcmlmaWVkIScpXG4gICAgICApO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydsb2ctaW4nXSk7XG4gICAgfSksXG4gICAgbWFwKCgpID0+IG5ldyBSZXNldEF1dGhTdGF0ZSgpKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2VuZEFjdGl2YXRpb25Db2RlRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9BQ1RJVkFUSU9OX0NPREVfRkFJTFVSRSksXG4gICAgdGFwKChlcnJvcjogU2VuZEFjdGl2YXRpb25Db2RlRmFpbHVyZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNlbmRBY3RpdmF0aW9uQ29kZUZhaWx1cmUnLCAnUGxlYXNlIHRyeSBhZ2FpbiB3aXRoIHRoZSBjb3JyZWN0IGNvZGUuJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2dJbiQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOKSxcbiAgICBmaWx0ZXIoKGFjdGlvbjogTG9nSW4pID0+IGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpLFxuICAgIG1hcCgoYWN0aW9uOiBMb2dJbikgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgIHN3aXRjaE1hcCgodXNlcjogVXNlcikgPT4gdGhpcy5hdXRoU2VydmljZS5sb2dpbih1c2VyKS5waXBlKFxuICAgICAgY29uY2F0TWFwKChsb2dnZWRJblVzZXI6IFVzZXIpID0+IHtcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndG9rZW4nLCBsb2dnZWRJblVzZXIudG9rZW4udG9rZW4pO1xuICAgICAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5nZXRVc2VySW5mb3JtYXRpb24oKS5waXBlKFxuICAgICAgICAgIG1hcCgoeyB1c2VyLCB1c2Vyc0xpc3QgfSkgPT4gbmV3IExvZ0luU3VjY2Vzcyh7IHVzZXIsIHVzZXJzTGlzdCB9KSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9nSW5GYWlsdXJlKGVycm9yKSkpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IExvZ0luRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBMb2dJblN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTl9TVUNDRVNTKSxcbiAgICBmaWx0ZXIoKGFjdGlvbjogTG9nSW5TdWNjZXNzKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSxcbiAgICB3aXRoTGF0ZXN0RnJvbSh0aGlzLnN0b3JlLnBpcGUoc2VsZWN0KHNlbGVjdFVzZXIpKSksXG4gICAgdGFwKChbYWN0aW9uLCB1c2VyXTogW0xvZ0luU3VjY2VzcywgVXNlcl0pID0+IHtcbiAgICAgIGNvbnN0IHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgncmVkaXJlY3RlZFVybEFmdGVyTG9nSW4nKTtcbiAgICAgIGlmIChyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbiAmJiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwocmVkaXJlY3RlZFVybEFmdGVyTG9nSW4pO1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybCh1c2VyLnJlZGlyZWN0VXJsQWZ0ZXJMb2dpbik7XG4gICAgICB9XG4gICAgICB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmxvZ2luU3VjY2VzcycsICdIaSEgTmljZSB0byBzZWUgeW91IGFnYWluIScpXG4gICAgICApO1xuICAgIH0pXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBMb2dJbkZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTl9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBMb2dJbkZhaWx1cmUpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5sb2dpbkZhaWx1cmUnLCAnV3JvbmcgY3JlZGVudGlhbHMuIFBsZWFzZSBjaGVjayBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIExvZ091dCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX09VVCksXG4gICAgZmlsdGVyKChhY3Rpb246IExvZ091dCkgPT4gaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IExvZ091dCkgPT4ge1xuICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgndG9rZW4nKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnbG9nLWluJ10pO1xuICAgICAgcmV0dXJuICh0aGlzLnJlc2V0QWN0aW9ucyB8fCBbXSkubWFwKChyZXNldEFjdGlvbjogYW55KSA9PiBuZXcgcmVzZXRBY3Rpb24oKSlcbiAgICB9KVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2FkVXNlckluZm9ybWF0aW9uJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5MT0FEX1VTRVJfSU5GT1JNQVRJT04pLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBMb2FkVXNlckluZm9ybWF0aW9uKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmdldFVzZXJJbmZvcm1hdGlvbigpLnBpcGUoXG4gICAgICBtYXAoKHsgdXNlciwgdXNlcnNMaXN0IH0pID0+IG5ldyBMb2FkVXNlckluZm9ybWF0aW9uU3VjY2Vzcyh1c2VyKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBMb2FkVXNlckluZm9ybWF0aW9uRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIENoYW5nZVBhc3N3b3JkJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5DSEFOR0VfUEFTU1dPUkQpLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBDaGFuZ2VQYXNzd29yZCkgPT4gdGhpcy5hdXRoU2VydmljZS5jaGFuZ2VQYXNzd29yZChhY3Rpb24ucGF5bG9hZCkucGlwZShcbiAgICAgIG1hcCgoKSA9PiBuZXcgQ2hhbmdlUGFzc3dvcmRTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgQ2hhbmdlUGFzc3dvcmRGYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIENoYW5nZVBhc3N3b3JkU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuQ0hBTkdFX1BBU1NXT1JEX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5jaGFuZ2VQYXNzd29yZFN1Y2Nlc3MnLCAnWW91ciBwYXNzd29yZCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgY2hhbmdlZCEnKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBDaGFuZ2VQYXNzd29yZEZhaWx1cmUkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkNIQU5HRV9QQVNTV09SRF9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBDaGFuZ2VQYXNzd29yZEZhaWx1cmUpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5jaGFuZ2VQYXNzd29yZEZhaWx1cmUnLCAnV3JvbmcgY3VycmVudCBwYXNzd29yZC4gUGxlYXNlIHRyeSBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBPcGVuRm9yZ290dGVuUGFzc3dvcmREaWFsb2ckID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLk9QRU5fRk9SR09UVEVOX1BBU1NXT1JEX0RJQUxPRyksXG4gICAgdGFwKCgpID0+IHRoaXMuZGlhbG9nUmVmID0gdGhpcy5kaWFsb2cub3BlbihGb3Jnb3R0ZW5QYXNzd29yZENvbXBvbmVudCkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIFNlbmRQYXNzd29yZCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9QQVNTV09SRCksXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgfSksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IFNlbmRQYXNzd29yZCkgPT4gdGhpcy5hdXRoU2VydmljZS5zZW5kUGFzc3dvcmQoYWN0aW9uLnBheWxvYWQpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4gbmV3IFNlbmRQYXNzd29yZFN1Y2Nlc3MoKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBTZW5kUGFzc3dvcmRGYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNlbmRQYXNzd29yZFN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfUEFTU1dPUkRfU1VDQ0VTUyksXG4gICAgdGFwKCgpID0+IHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnBhc3N3b3JkUmVzZXRTdWNjZXNzJywgJ0FuIGVtYWlsIGZvciByZXNldHRpbmcgeW91ciBwYXNzd29yZCBoYXMgYmVlbiBzZW50IHRvIHlvdXIgYWRkcmVzcy4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTZW5kUGFzc3dvcmRGYWlsdXJlJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TRU5EX1BBU1NXT1JEX0ZBSUxVUkUpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMucGFzc3dvcmRSZXNldEZhaWx1cmUnLCAnQW4gZXJyb3Igb2NjdXJlZC4gUGxlYXNlIHRyeSBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG59XG4iXX0=