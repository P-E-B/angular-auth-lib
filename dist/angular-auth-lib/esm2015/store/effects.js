import { __decorate, __param } from "tslib";
import { Injectable, Inject } from '@angular/core';
import { Router } from '@angular/router';
import { Actions, Effect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { ToastrService } from 'ngx-toastr';
import { Store, select } from '@ngrx/store';
import { MatDialogRef, MatDialog } from '@angular/material/dialog';
import { map, switchMap, catchError, tap, withLatestFrom, concatMap } from 'rxjs/operators';
import { get } from 'lodash';
import { AUTH_ACTIONS_TYPE, LogInSuccess, LogInFailure, SignUpFailure, SignUpSuccess, ChangePasswordSuccess, ChangePasswordFailure, LoadUserInformationSuccess, LoadUserInformationFailure, SendPasswordSuccess, SendPasswordFailure } from './actions';
import { selectUser } from './selectors';
import { AuthService } from '../services/auth.service';
import { ForgottenPasswordComponent } from '../components/forgotten-password/forgotten-password.component';
import { AUTH_RESET_ACTIONS, AUTH_TRADUCTIONS } from '../token';
import { SignUpComponent } from '../components/sign-up/sign-up.component';
let AuthEffects = class AuthEffects {
    constructor(resetActions, traductions, actions, authService, router, toastService, dialog, store) {
        this.resetActions = resetActions;
        this.traductions = traductions;
        this.actions = actions;
        this.authService = authService;
        this.router = router;
        this.toastService = toastService;
        this.dialog = dialog;
        this.store = store;
        this.OpenSignUpDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_SIGN_UP_DIALOG), tap(() => this.dialogRef = this.dialog.open(SignUpComponent)));
        this.SignUp$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP), map((action) => action.payload), switchMap((user) => this.authService.createUser(user).pipe(map(() => new SignUpSuccess()), catchError((error) => of(new SignUpFailure(error))))));
        this.SignUpSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_SUCCESS), tap(() => {
            this.toastService.success(get(this.traductions || {}, 'messages.signupSuccess', 'Your account has been created!'));
        }));
        this.SignUpFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.signupFailure', 'Please try again with a new username.'))));
        this.LogIn$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN), map((action) => action.payload), switchMap((user) => this.authService.login(user).pipe(concatMap((loggedInUser) => {
            sessionStorage.setItem('token', loggedInUser.token.token);
            return this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LogInSuccess({ user, usersList })), catchError((error) => of(new LogInFailure(error))));
        }), catchError((error) => of(new LogInFailure(error))))));
        this.LogInSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_SUCCESS), withLatestFrom(this.store.pipe(select(selectUser))), tap(([action, user]) => {
            const redirectedUrlAfterLogIn = sessionStorage.getItem('redirectedUrlAfterLogIn');
            if (redirectedUrlAfterLogIn) {
                this.router.navigateByUrl(redirectedUrlAfterLogIn);
                sessionStorage.removeItem('redirectedUrlAfterLogIn');
            }
            else {
                this.router.navigateByUrl(user.redirectUrlAfterLogin);
            }
            this.toastService.success(get(this.traductions || {}, 'messages.loginSuccess', 'Hi! Nice to see you again!'));
        }));
        this.LogInFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.loginFailure', 'Wrong credentials. Please check again.'))));
        this.LogOut$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_OUT), switchMap((action) => {
            sessionStorage.removeItem('token');
            this.router.navigate(['log-in']);
            return (this.resetActions || []).map((resetAction) => new resetAction());
        }));
        this.LoadUserInformation$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOAD_USER_INFORMATION), switchMap((action) => this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LoadUserInformationSuccess(user)), catchError((error) => of(new LoadUserInformationFailure(error))))));
        this.ChangePassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD), switchMap((action) => this.authService.changePassword(action.payload).pipe(map(() => new ChangePasswordSuccess()), catchError((error) => of(new ChangePasswordFailure(error))))));
        this.ChangePasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.changePasswordSuccess', 'Your password has been successfully changed!'))));
        this.ChangePasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.changePasswordFailure', 'Wrong current password. Please try again.'))));
        this.OpenForgottenPasswordDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_FORGOTTEN_PASSWORD_DIALOG), tap(() => this.dialogRef = this.dialog.open(ForgottenPasswordComponent)));
        this.SendPassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD), tap(() => {
            this.dialogRef.close();
        }), switchMap((action) => this.authService.sendPassword(action.payload).pipe(map(() => new SendPasswordSuccess()), catchError((error) => of(new SendPasswordFailure(error))))));
        this.SendPasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.passwordResetSuccess', 'An email for resetting your password has been sent to your address.'))));
        this.SendPasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_FAILURE), tap(() => this.toastService.error(get(this.traductions || {}, 'messages.passwordResetFailure', 'An error occured. Please try again.'))));
    }
};
AuthEffects.ctorParameters = () => [
    { type: Array, decorators: [{ type: Inject, args: [AUTH_RESET_ACTIONS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [AUTH_TRADUCTIONS,] }] },
    { type: Actions },
    { type: AuthService },
    { type: Router },
    { type: ToastrService },
    { type: MatDialog },
    { type: Store }
];
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenSignUpDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SignUp$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogIn$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogOut$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LoadUserInformation$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "ChangePassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordFailure$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenForgottenPasswordDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SendPassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordFailure$", void 0);
AuthEffects = __decorate([
    Injectable(),
    __param(0, Inject(AUTH_RESET_ACTIONS)),
    __param(1, Inject(AUTH_TRADUCTIONS))
], AuthEffects);
export { AuthEffects };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItYXV0aC1saWIvIiwic291cmNlcyI6WyJzdG9yZS9lZmZlY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFMUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1QyxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVGLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFN0IsT0FBTyxFQUNMLGlCQUFpQixFQUVqQixZQUFZLEVBQ1osWUFBWSxFQUdaLGFBQWEsRUFDYixhQUFhLEVBRWIscUJBQXFCLEVBQ3JCLHFCQUFxQixFQUNyQiwwQkFBMEIsRUFDMUIsMEJBQTBCLEVBRzFCLG1CQUFtQixFQUNuQixtQkFBbUIsRUFDcEIsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV6QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDdkQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sK0RBQStELENBQUM7QUFDM0csT0FB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QUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDOzJEQU0xQjtBQUdGO0lBREMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDO2lFQUkxQjtBQUdGO0lBREMsTUFBTSxFQUFFO2tEQVVQO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7eURBTTFCO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7eURBTTFCO0FBdEtTLFdBQVc7SUFEdkIsVUFBVSxFQUFFO0lBS1IsV0FBQSxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtJQUMxQixXQUFBLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0dBTGhCLFdBQVcsQ0F1S3ZCO1NBdktZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBY3Rpb25zLCBFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgVG9hc3RyU2VydmljZSB9IGZyb20gJ25neC10b2FzdHInO1xuaW1wb3J0IHsgU3RvcmUsIHNlbGVjdCB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7IE1hdERpYWxvZ1JlZiwgTWF0RGlhbG9nIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGlhbG9nJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCBjYXRjaEVycm9yLCB0YXAsIHdpdGhMYXRlc3RGcm9tLCBjb25jYXRNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7XG4gIEFVVEhfQUNUSU9OU19UWVBFLFxuICBMb2dJbixcbiAgTG9nSW5TdWNjZXNzLFxuICBMb2dJbkZhaWx1cmUsXG4gIExvZ091dCxcbiAgU2lnblVwLFxuICBTaWduVXBGYWlsdXJlLFxuICBTaWduVXBTdWNjZXNzLFxuICBDaGFuZ2VQYXNzd29yZCxcbiAgQ2hhbmdlUGFzc3dvcmRTdWNjZXNzLFxuICBDaGFuZ2VQYXNzd29yZEZhaWx1cmUsXG4gIExvYWRVc2VySW5mb3JtYXRpb25TdWNjZXNzLFxuICBMb2FkVXNlckluZm9ybWF0aW9uRmFpbHVyZSxcbiAgTG9hZFVzZXJJbmZvcm1hdGlvbixcbiAgU2VuZFBhc3N3b3JkLFxuICBTZW5kUGFzc3dvcmRTdWNjZXNzLFxuICBTZW5kUGFzc3dvcmRGYWlsdXJlXG59IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBzZWxlY3RVc2VyIH0gZnJvbSAnLi9zZWxlY3RvcnMnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy91c2VyLm1vZGVscyc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBGb3Jnb3R0ZW5QYXNzd29yZENvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvZm9yZ290dGVuLXBhc3N3b3JkL2ZvcmdvdHRlbi1wYXNzd29yZC5jb21wb25lbnQnO1xuaW1wb3J0IHsgQVVUSF9SRVNFVF9BQ1RJT05TLCBBVVRIX1RSQURVQ1RJT05TLCBBdXRoTW9kdWxlQ29uZmlnIH0gZnJvbSAnLi4vdG9rZW4nO1xuaW1wb3J0IHsgQXV0aFN0YXRlIH0gZnJvbSAnLi9yZWR1Y2VyJztcbmltcG9ydCB7IFNpZ25VcENvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvc2lnbi11cC9zaWduLXVwLmNvbXBvbmVudCc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhFZmZlY3RzIHtcbiAgcHJpdmF0ZSBkaWFsb2dSZWY6IE1hdERpYWxvZ1JlZjxTaWduVXBDb21wb25lbnQgfCBGb3Jnb3R0ZW5QYXNzd29yZENvbXBvbmVudD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChBVVRIX1JFU0VUX0FDVElPTlMpIHByaXZhdGUgcmVzZXRBY3Rpb25zOiBhbnlbXSxcbiAgICBASW5qZWN0KEFVVEhfVFJBRFVDVElPTlMpIHByaXZhdGUgdHJhZHVjdGlvbnM6IEF1dGhNb2R1bGVDb25maWdbJ3RyYWR1Y3Rpb25zJ10sXG4gICAgcHJpdmF0ZSBhY3Rpb25zOiBBY3Rpb25zLFxuICAgIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSB0b2FzdFNlcnZpY2U6IFRvYXN0clNlcnZpY2UsXG4gICAgcHJpdmF0ZSBkaWFsb2c6IE1hdERpYWxvZyxcbiAgICBwcml2YXRlIHN0b3JlOiBTdG9yZTxBdXRoU3RhdGU+XG4gICkgeyB9XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBPcGVuU2lnblVwRGlhbG9nJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5PUEVOX1NJR05fVVBfRElBTE9HKSxcbiAgICB0YXAoKCkgPT4gdGhpcy5kaWFsb2dSZWYgPSB0aGlzLmRpYWxvZy5vcGVuKFNpZ25VcENvbXBvbmVudCkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIFNpZ25VcCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0lHTl9VUCksXG4gICAgbWFwKChhY3Rpb246IFNpZ25VcCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgIHN3aXRjaE1hcCgodXNlcjogVXNlcikgPT4gdGhpcy5hdXRoU2VydmljZS5jcmVhdGVVc2VyKHVzZXIpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4gbmV3IFNpZ25VcFN1Y2Nlc3MoKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBTaWduVXBGYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNpZ25VcFN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNJR05fVVBfU1VDQ0VTUyksXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMuc2lnbnVwU3VjY2VzcycsICdZb3VyIGFjY291bnQgaGFzIGJlZW4gY3JlYXRlZCEnKVxuICAgICAgKVxuICAgIH0pXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTaWduVXBGYWlsdXJlJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TSUdOX1VQX0ZBSUxVUkUpLFxuICAgIHRhcCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMuc2lnbnVwRmFpbHVyZScsICdQbGVhc2UgdHJ5IGFnYWluIHdpdGggYSBuZXcgdXNlcm5hbWUuJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2dJbiQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOKSxcbiAgICBtYXAoKGFjdGlvbjogTG9nSW4pID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHVzZXI6IFVzZXIpID0+IHRoaXMuYXV0aFNlcnZpY2UubG9naW4odXNlcikucGlwZShcbiAgICAgIGNvbmNhdE1hcCgobG9nZ2VkSW5Vc2VyOiBVc2VyKSA9PiB7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3Rva2VuJywgbG9nZ2VkSW5Vc2VyLnRva2VuLnRva2VuKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UuZ2V0VXNlckluZm9ybWF0aW9uKCkucGlwZShcbiAgICAgICAgICBtYXAoKHt1c2VyLCB1c2Vyc0xpc3R9KSA9PiBuZXcgTG9nSW5TdWNjZXNzKHsgdXNlciwgdXNlcnNMaXN0IH0pKSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBMb2dJbkZhaWx1cmUoZXJyb3IpKSlcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9nSW5GYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIExvZ0luU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOX1NVQ0NFU1MpLFxuICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuc3RvcmUucGlwZShzZWxlY3Qoc2VsZWN0VXNlcikpKSxcbiAgICB0YXAoKFthY3Rpb24sIHVzZXJdOiBbTG9nSW5TdWNjZXNzLCBVc2VyXSkgPT4ge1xuICAgICAgY29uc3QgcmVkaXJlY3RlZFVybEFmdGVyTG9nSW4gPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCdyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbicpO1xuICAgICAgaWYgKHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwocmVkaXJlY3RlZFVybEFmdGVyTG9nSW4pXG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3JlZGlyZWN0ZWRVcmxBZnRlckxvZ0luJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVzZXIucmVkaXJlY3RVcmxBZnRlckxvZ2luKTtcbiAgICAgIH1cbiAgICAgIHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMubG9naW5TdWNjZXNzJywgJ0hpISBOaWNlIHRvIHNlZSB5b3UgYWdhaW4hJylcbiAgICAgICk7XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIExvZ0luRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOX0ZBSUxVUkUpLFxuICAgIHRhcCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMubG9naW5GYWlsdXJlJywgJ1dyb25nIGNyZWRlbnRpYWxzLiBQbGVhc2UgY2hlY2sgYWdhaW4uJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2dPdXQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19PVVQpLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBMb2dPdXQpID0+IHtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3Rva2VuJyk7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ2xvZy1pbiddKTtcbiAgICAgIHJldHVybiAodGhpcy5yZXNldEFjdGlvbnMgfHwgW10pLm1hcCgocmVzZXRBY3Rpb246IGFueSkgPT4gbmV3IHJlc2V0QWN0aW9uKCkpXG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgTG9hZFVzZXJJbmZvcm1hdGlvbiQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9BRF9VU0VSX0lORk9STUFUSU9OKSxcbiAgICBzd2l0Y2hNYXAoKGFjdGlvbjogTG9hZFVzZXJJbmZvcm1hdGlvbikgPT4gdGhpcy5hdXRoU2VydmljZS5nZXRVc2VySW5mb3JtYXRpb24oKS5waXBlKFxuICAgICAgbWFwKCh7dXNlciwgdXNlcnNMaXN0fSkgPT4gbmV3IExvYWRVc2VySW5mb3JtYXRpb25TdWNjZXNzKHVzZXIpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IExvYWRVc2VySW5mb3JtYXRpb25GYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgQ2hhbmdlUGFzc3dvcmQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkNIQU5HRV9QQVNTV09SRCksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IENoYW5nZVBhc3N3b3JkKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmNoYW5nZVBhc3N3b3JkKGFjdGlvbi5wYXlsb2FkKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBDaGFuZ2VQYXNzd29yZFN1Y2Nlc3MoKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBDaGFuZ2VQYXNzd29yZEZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgQ2hhbmdlUGFzc3dvcmRTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5DSEFOR0VfUEFTU1dPUkRfU1VDQ0VTUyksXG4gICAgdGFwKCgpID0+IHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLmNoYW5nZVBhc3N3b3JkU3VjY2VzcycsICdZb3VyIHBhc3N3b3JkIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBjaGFuZ2VkIScpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIENoYW5nZVBhc3N3b3JkRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuQ0hBTkdFX1BBU1NXT1JEX0ZBSUxVUkUpLFxuICAgIHRhcCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMuY2hhbmdlUGFzc3dvcmRGYWlsdXJlJywgJ1dyb25nIGN1cnJlbnQgcGFzc3dvcmQuIFBsZWFzZSB0cnkgYWdhaW4uJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgT3BlbkZvcmdvdHRlblBhc3N3b3JkRGlhbG9nJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5PUEVOX0ZPUkdPVFRFTl9QQVNTV09SRF9ESUFMT0cpLFxuICAgIHRhcCgoKSA9PiB0aGlzLmRpYWxvZ1JlZiA9IHRoaXMuZGlhbG9nLm9wZW4oRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQpKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBTZW5kUGFzc3dvcmQkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfUEFTU1dPUkQpLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgIH0pLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBTZW5kUGFzc3dvcmQpID0+IHRoaXMuYXV0aFNlcnZpY2Uuc2VuZFBhc3N3b3JkKGFjdGlvbi5wYXlsb2FkKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBTZW5kUGFzc3dvcmRTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgU2VuZFBhc3N3b3JkRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTZW5kUGFzc3dvcmRTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TRU5EX1BBU1NXT1JEX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5wYXNzd29yZFJlc2V0U3VjY2VzcycsICdBbiBlbWFpbCBmb3IgcmVzZXR0aW5nIHlvdXIgcGFzc3dvcmQgaGFzIGJlZW4gc2VudCB0byB5b3VyIGFkZHJlc3MuJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2VuZFBhc3N3b3JkRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9QQVNTV09SRF9GQUlMVVJFKSxcbiAgICB0YXAoKCkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnBhc3N3b3JkUmVzZXRGYWlsdXJlJywgJ0FuIGVycm9yIG9jY3VyZWQuIFBsZWFzZSB0cnkgYWdhaW4uJylcbiAgICApKVxuICApO1xufVxuIl19