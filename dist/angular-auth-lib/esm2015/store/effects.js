import { __decorate, __param } from "tslib";
import { Injectable, Inject, PLATFORM_ID } from '@angular/core';
import { Router } from '@angular/router';
import { Actions, Effect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { ToastrService } from 'ngx-toastr';
import { Store, select } from '@ngrx/store';
import { MatDialogRef, MatDialog } from '@angular/material/dialog';
import { map, switchMap, catchError, tap, withLatestFrom, concatMap, filter } from 'rxjs/operators';
import get from 'lodash-es/get';
import { AUTH_ACTIONS_TYPE, LogInSuccess, LogInFailure, SignUpFailure, SignUpSuccess, ChangePasswordSuccess, ChangePasswordFailure, LoadUserInformationSuccess, LoadUserInformationFailure, SendPasswordSuccess, SendPasswordFailure } from './actions';
import { selectUser } from './selectors';
import { AuthService } from '../services/auth.service';
import { ForgottenPasswordComponent } from '../components/forgotten-password/forgotten-password.component';
import { AUTH_RESET_ACTIONS, AUTH_TRADUCTIONS } from '../token';
import { SignUpComponent } from '../components/sign-up/sign-up.component';
import { isPlatformBrowser } from '@angular/common';
let AuthEffects = class AuthEffects {
    constructor(resetActions, traductions, platformId, actions, authService, router, toastService, dialog, store) {
        this.resetActions = resetActions;
        this.traductions = traductions;
        this.platformId = platformId;
        this.actions = actions;
        this.authService = authService;
        this.router = router;
        this.toastService = toastService;
        this.dialog = dialog;
        this.store = store;
        this.OpenSignUpDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_SIGN_UP_DIALOG), tap(() => this.dialogRef = this.dialog.open(SignUpComponent)));
        this.SignUp$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP), map((action) => action.payload), switchMap((user) => this.authService.createUser(user).pipe(map(() => new SignUpSuccess()), catchError((error) => of(new SignUpFailure(error))))));
        this.SignUpSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_SUCCESS), tap(() => {
            this.toastService.success(get(this.traductions || {}, 'messages.signupSuccess', 'Your account has been created!'));
        }));
        this.SignUpFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SIGN_UP_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.signupFailure', 'Please try again with a new username.'))));
        this.LogIn$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN), filter((action) => isPlatformBrowser(this.platformId)), map((action) => action.payload), switchMap((user) => this.authService.login(user).pipe(concatMap((loggedInUser) => {
            sessionStorage.setItem('token', loggedInUser.token.token);
            return this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LogInSuccess({ user, usersList })), catchError((error) => of(new LogInFailure(error))));
        }), catchError((error) => of(new LogInFailure(error))))));
        this.LogInSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_SUCCESS), filter((action) => isPlatformBrowser(this.platformId)), withLatestFrom(this.store.pipe(select(selectUser))), tap(([action, user]) => {
            const redirectedUrlAfterLogIn = sessionStorage.getItem('redirectedUrlAfterLogIn');
            if (redirectedUrlAfterLogIn && isPlatformBrowser(this.platformId)) {
                this.router.navigateByUrl(redirectedUrlAfterLogIn);
                sessionStorage.removeItem('redirectedUrlAfterLogIn');
            }
            else {
                this.router.navigateByUrl(user.redirectUrlAfterLogin);
            }
            this.toastService.success(get(this.traductions || {}, 'messages.loginSuccess', 'Hi! Nice to see you again!'));
        }));
        this.LogInFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_IN_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.loginFailure', 'Wrong credentials. Please check again.'))));
        this.LogOut$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOG_OUT), filter((action) => isPlatformBrowser(this.platformId)), switchMap((action) => {
            sessionStorage.removeItem('token');
            this.router.navigate(['log-in']);
            return (this.resetActions || []).map((resetAction) => new resetAction());
        }));
        this.LoadUserInformation$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.LOAD_USER_INFORMATION), switchMap((action) => this.authService.getUserInformation().pipe(map(({ user, usersList }) => new LoadUserInformationSuccess(user)), catchError((error) => of(new LoadUserInformationFailure(error))))));
        this.ChangePassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD), switchMap((action) => this.authService.changePassword(action.payload).pipe(map(() => new ChangePasswordSuccess()), catchError((error) => of(new ChangePasswordFailure(error))))));
        this.ChangePasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.changePasswordSuccess', 'Your password has been successfully changed!'))));
        this.ChangePasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.CHANGE_PASSWORD_FAILURE), tap((error) => this.toastService.error(get(this.traductions || {}, 'messages.changePasswordFailure', 'Wrong current password. Please try again.'))));
        this.OpenForgottenPasswordDialog$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.OPEN_FORGOTTEN_PASSWORD_DIALOG), tap(() => this.dialogRef = this.dialog.open(ForgottenPasswordComponent)));
        this.SendPassword$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD), tap(() => {
            this.dialogRef.close();
        }), switchMap((action) => this.authService.sendPassword(action.payload).pipe(map(() => new SendPasswordSuccess()), catchError((error) => of(new SendPasswordFailure(error))))));
        this.SendPasswordSuccess$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_SUCCESS), tap(() => this.toastService.success(get(this.traductions || {}, 'messages.passwordResetSuccess', 'An email for resetting your password has been sent to your address.'))));
        this.SendPasswordFailure$ = this.actions.pipe(ofType(AUTH_ACTIONS_TYPE.SEND_PASSWORD_FAILURE), tap(() => this.toastService.error(get(this.traductions || {}, 'messages.passwordResetFailure', 'An error occured. Please try again.'))));
    }
};
AuthEffects.ctorParameters = () => [
    { type: Array, decorators: [{ type: Inject, args: [AUTH_RESET_ACTIONS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [AUTH_TRADUCTIONS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: Actions },
    { type: AuthService },
    { type: Router },
    { type: ToastrService },
    { type: MatDialog },
    { type: Store }
];
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenSignUpDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SignUp$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SignUpFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogIn$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "LogInFailure$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LogOut$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "LoadUserInformation$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "ChangePassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "ChangePasswordFailure$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "OpenForgottenPasswordDialog$", void 0);
__decorate([
    Effect()
], AuthEffects.prototype, "SendPassword$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordSuccess$", void 0);
__decorate([
    Effect({ dispatch: false })
], AuthEffects.prototype, "SendPasswordFailure$", void 0);
AuthEffects = __decorate([
    Injectable(),
    __param(0, Inject(AUTH_RESET_ACTIONS)),
    __param(1, Inject(AUTH_TRADUCTIONS)),
    __param(2, Inject(PLATFORM_ID))
], AuthEffects);
export { AuthEffects };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZmZWN0cy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItYXV0aC1saWIvIiwic291cmNlcyI6WyJzdG9yZS9lZmZlY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEcsT0FBTyxHQUFHLE1BQU0sZUFBZSxDQUFDO0FBRWhDLE9BQU8sRUFDTCxpQkFBaUIsRUFFakIsWUFBWSxFQUNaLFlBQVksRUFHWixhQUFhLEVBQ2IsYUFBYSxFQUViLHFCQUFxQixFQUNyQixxQkFBcUIsRUFDckIsMEJBQTBCLEVBQzFCLDBCQUEwQixFQUcxQixtQkFBbUIsRUFDbkIsbUJBQW1CLEVBQ3BCLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFekMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLCtEQUErRCxDQUFD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QUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7bURBUTFCO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7bURBTTFCO0FBR0Y7SUFEQyxNQUFNLEVBQUU7MkNBZVA7QUFHRjtJQURDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQztrREFpQjFCO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7a0RBTTFCO0FBR0Y7SUFEQyxNQUFNLEVBQUU7NENBU1A7QUFHRjtJQURDLE1BQU0sRUFBRTt5REFPUDtBQUdGO0lBREMsTUFBTSxFQUFFO29EQU9QO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7MkRBTTFCO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7MkRBTTFCO0FBR0Y7SUFEQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7aUVBSTFCO0FBR0Y7SUFEQyxNQUFNLEVBQUU7a0RBVVA7QUFHRjtJQURDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQzt5REFNMUI7QUFHRjtJQURDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQzt5REFNMUI7QUExS1MsV0FBVztJQUR2QixVQUFVLEVBQUU7SUFLUixXQUFBLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO0lBQzFCLFdBQUEsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUE7SUFDeEIsV0FBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7R0FOWCxXQUFXLENBMkt2QjtTQTNLWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEFjdGlvbnMsIEVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBUb2FzdHJTZXJ2aWNlIH0gZnJvbSAnbmd4LXRvYXN0cic7XG5pbXBvcnQgeyBTdG9yZSwgc2VsZWN0IH0gZnJvbSAnQG5ncngvc3RvcmUnO1xuaW1wb3J0IHsgTWF0RGlhbG9nUmVmLCBNYXREaWFsb2cgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAsIGNhdGNoRXJyb3IsIHRhcCwgd2l0aExhdGVzdEZyb20sIGNvbmNhdE1hcCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgZ2V0IGZyb20gJ2xvZGFzaC1lcy9nZXQnO1xuXG5pbXBvcnQge1xuICBBVVRIX0FDVElPTlNfVFlQRSxcbiAgTG9nSW4sXG4gIExvZ0luU3VjY2VzcyxcbiAgTG9nSW5GYWlsdXJlLFxuICBMb2dPdXQsXG4gIFNpZ25VcCxcbiAgU2lnblVwRmFpbHVyZSxcbiAgU2lnblVwU3VjY2VzcyxcbiAgQ2hhbmdlUGFzc3dvcmQsXG4gIENoYW5nZVBhc3N3b3JkU3VjY2VzcyxcbiAgQ2hhbmdlUGFzc3dvcmRGYWlsdXJlLFxuICBMb2FkVXNlckluZm9ybWF0aW9uU3VjY2VzcyxcbiAgTG9hZFVzZXJJbmZvcm1hdGlvbkZhaWx1cmUsXG4gIExvYWRVc2VySW5mb3JtYXRpb24sXG4gIFNlbmRQYXNzd29yZCxcbiAgU2VuZFBhc3N3b3JkU3VjY2VzcyxcbiAgU2VuZFBhc3N3b3JkRmFpbHVyZVxufSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgc2VsZWN0VXNlciB9IGZyb20gJy4vc2VsZWN0b3JzJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9tb2RlbHMvdXNlci5tb2RlbHMnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2ZvcmdvdHRlbi1wYXNzd29yZC9mb3Jnb3R0ZW4tcGFzc3dvcmQuY29tcG9uZW50JztcbmltcG9ydCB7IEFVVEhfUkVTRVRfQUNUSU9OUywgQVVUSF9UUkFEVUNUSU9OUywgQXV0aE1vZHVsZUNvbmZpZyB9IGZyb20gJy4uL3Rva2VuJztcbmltcG9ydCB7IEF1dGhTdGF0ZSB9IGZyb20gJy4vcmVkdWNlcic7XG5pbXBvcnQgeyBTaWduVXBDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL3NpZ24tdXAvc2lnbi11cC5jb21wb25lbnQnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoRWZmZWN0cyB7XG4gIHByaXZhdGUgZGlhbG9nUmVmOiBNYXREaWFsb2dSZWY8U2lnblVwQ29tcG9uZW50IHwgRm9yZ290dGVuUGFzc3dvcmRDb21wb25lbnQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoQVVUSF9SRVNFVF9BQ1RJT05TKSBwcml2YXRlIHJlc2V0QWN0aW9uczogYW55W10sXG4gICAgQEluamVjdChBVVRIX1RSQURVQ1RJT05TKSBwcml2YXRlIHRyYWR1Y3Rpb25zOiBBdXRoTW9kdWxlQ29uZmlnWyd0cmFkdWN0aW9ucyddLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogYW55LFxuICAgIHByaXZhdGUgYWN0aW9uczogQWN0aW9ucyxcbiAgICBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgdG9hc3RTZXJ2aWNlOiBUb2FzdHJTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGlhbG9nOiBNYXREaWFsb2csXG4gICAgcHJpdmF0ZSBzdG9yZTogU3RvcmU8QXV0aFN0YXRlPlxuICApIHsgfVxuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgT3BlblNpZ25VcERpYWxvZyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuT1BFTl9TSUdOX1VQX0RJQUxPRyksXG4gICAgdGFwKCgpID0+IHRoaXMuZGlhbG9nUmVmID0gdGhpcy5kaWFsb2cub3BlbihTaWduVXBDb21wb25lbnQpKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBTaWduVXAkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNJR05fVVApLFxuICAgIG1hcCgoYWN0aW9uOiBTaWduVXApID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHVzZXI6IFVzZXIpID0+IHRoaXMuYXV0aFNlcnZpY2UuY3JlYXRlVXNlcih1c2VyKS5waXBlKFxuICAgICAgbWFwKCgpID0+IG5ldyBTaWduVXBTdWNjZXNzKCkpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgU2lnblVwRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTaWduVXBTdWNjZXNzJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TSUdOX1VQX1NVQ0NFU1MpLFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnRvYXN0U2VydmljZS5zdWNjZXNzKFxuICAgICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNpZ251cFN1Y2Nlc3MnLCAnWW91ciBhY2NvdW50IGhhcyBiZWVuIGNyZWF0ZWQhJylcbiAgICAgIClcbiAgICB9KVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgU2lnblVwRmFpbHVyZSQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0lHTl9VUF9GQUlMVVJFKSxcbiAgICB0YXAoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy50b2FzdFNlcnZpY2UuZXJyb3IoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnNpZ251cEZhaWx1cmUnLCAnUGxlYXNlIHRyeSBhZ2FpbiB3aXRoIGEgbmV3IHVzZXJuYW1lLicpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgTG9nSW4kID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkxPR19JTiksXG4gICAgZmlsdGVyKChhY3Rpb246IExvZ0luKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSxcbiAgICBtYXAoKGFjdGlvbjogTG9nSW4pID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHVzZXI6IFVzZXIpID0+IHRoaXMuYXV0aFNlcnZpY2UubG9naW4odXNlcikucGlwZShcbiAgICAgIGNvbmNhdE1hcCgobG9nZ2VkSW5Vc2VyOiBVc2VyKSA9PiB7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3Rva2VuJywgbG9nZ2VkSW5Vc2VyLnRva2VuLnRva2VuKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UuZ2V0VXNlckluZm9ybWF0aW9uKCkucGlwZShcbiAgICAgICAgICBtYXAoKHt1c2VyLCB1c2Vyc0xpc3R9KSA9PiBuZXcgTG9nSW5TdWNjZXNzKHsgdXNlciwgdXNlcnNMaXN0IH0pKSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBMb2dJbkZhaWx1cmUoZXJyb3IpKSlcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9nSW5GYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIExvZ0luU3VjY2VzcyQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX0lOX1NVQ0NFU1MpLFxuICAgIGZpbHRlcigoYWN0aW9uOiBMb2dJblN1Y2Nlc3MpID0+IGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpLFxuICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuc3RvcmUucGlwZShzZWxlY3Qoc2VsZWN0VXNlcikpKSxcbiAgICB0YXAoKFthY3Rpb24sIHVzZXJdOiBbTG9nSW5TdWNjZXNzLCBVc2VyXSkgPT4ge1xuICAgICAgY29uc3QgcmVkaXJlY3RlZFVybEFmdGVyTG9nSW4gPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCdyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbicpO1xuICAgICAgaWYgKHJlZGlyZWN0ZWRVcmxBZnRlckxvZ0luICYmIGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChyZWRpcmVjdGVkVXJsQWZ0ZXJMb2dJbilcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgncmVkaXJlY3RlZFVybEFmdGVyTG9nSW4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXNlci5yZWRpcmVjdFVybEFmdGVyTG9naW4pO1xuICAgICAgfVxuICAgICAgdGhpcy50b2FzdFNlcnZpY2Uuc3VjY2VzcyhcbiAgICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5sb2dpblN1Y2Nlc3MnLCAnSGkhIE5pY2UgdG8gc2VlIHlvdSBhZ2FpbiEnKVxuICAgICAgKTtcbiAgICB9KVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgTG9nSW5GYWlsdXJlJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5MT0dfSU5fRkFJTFVSRSksXG4gICAgdGFwKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5sb2dpbkZhaWx1cmUnLCAnV3JvbmcgY3JlZGVudGlhbHMuIFBsZWFzZSBjaGVjayBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIExvZ091dCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuTE9HX09VVCksXG4gICAgZmlsdGVyKChhY3Rpb246IExvZ091dCkgPT4gaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IExvZ091dCkgPT4ge1xuICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgndG9rZW4nKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnbG9nLWluJ10pO1xuICAgICAgcmV0dXJuICh0aGlzLnJlc2V0QWN0aW9ucyB8fCBbXSkubWFwKChyZXNldEFjdGlvbjogYW55KSA9PiBuZXcgcmVzZXRBY3Rpb24oKSlcbiAgICB9KVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBMb2FkVXNlckluZm9ybWF0aW9uJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5MT0FEX1VTRVJfSU5GT1JNQVRJT04pLFxuICAgIHN3aXRjaE1hcCgoYWN0aW9uOiBMb2FkVXNlckluZm9ybWF0aW9uKSA9PiB0aGlzLmF1dGhTZXJ2aWNlLmdldFVzZXJJbmZvcm1hdGlvbigpLnBpcGUoXG4gICAgICBtYXAoKHt1c2VyLCB1c2Vyc0xpc3R9KSA9PiBuZXcgTG9hZFVzZXJJbmZvcm1hdGlvblN1Y2Nlc3ModXNlcikpLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiBvZihuZXcgTG9hZFVzZXJJbmZvcm1hdGlvbkZhaWx1cmUoZXJyb3IpKSlcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBDaGFuZ2VQYXNzd29yZCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuQ0hBTkdFX1BBU1NXT1JEKSxcbiAgICBzd2l0Y2hNYXAoKGFjdGlvbjogQ2hhbmdlUGFzc3dvcmQpID0+IHRoaXMuYXV0aFNlcnZpY2UuY2hhbmdlUGFzc3dvcmQoYWN0aW9uLnBheWxvYWQpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4gbmV3IENoYW5nZVBhc3N3b3JkU3VjY2VzcygpKSxcbiAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gb2YobmV3IENoYW5nZVBhc3N3b3JkRmFpbHVyZShlcnJvcikpKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBDaGFuZ2VQYXNzd29yZFN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLkNIQU5HRV9QQVNTV09SRF9TVUNDRVNTKSxcbiAgICB0YXAoKCkgPT4gdGhpcy50b2FzdFNlcnZpY2Uuc3VjY2VzcyhcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMuY2hhbmdlUGFzc3dvcmRTdWNjZXNzJywgJ1lvdXIgcGFzc3dvcmQgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGNoYW5nZWQhJylcbiAgICApKVxuICApO1xuXG4gIEBFZmZlY3QoeyBkaXNwYXRjaDogZmFsc2UgfSlcbiAgQ2hhbmdlUGFzc3dvcmRGYWlsdXJlJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5DSEFOR0VfUEFTU1dPUkRfRkFJTFVSRSksXG4gICAgdGFwKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMudG9hc3RTZXJ2aWNlLmVycm9yKFxuICAgICAgZ2V0KHRoaXMudHJhZHVjdGlvbnMgfHwge30sICdtZXNzYWdlcy5jaGFuZ2VQYXNzd29yZEZhaWx1cmUnLCAnV3JvbmcgY3VycmVudCBwYXNzd29yZC4gUGxlYXNlIHRyeSBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBPcGVuRm9yZ290dGVuUGFzc3dvcmREaWFsb2ckID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLk9QRU5fRk9SR09UVEVOX1BBU1NXT1JEX0RJQUxPRyksXG4gICAgdGFwKCgpID0+IHRoaXMuZGlhbG9nUmVmID0gdGhpcy5kaWFsb2cub3BlbihGb3Jnb3R0ZW5QYXNzd29yZENvbXBvbmVudCkpXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIFNlbmRQYXNzd29yZCQgPSB0aGlzLmFjdGlvbnMucGlwZShcbiAgICBvZlR5cGUoQVVUSF9BQ1RJT05TX1RZUEUuU0VORF9QQVNTV09SRCksXG4gICAgdGFwKCgpID0+IHtcbiAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgfSksXG4gICAgc3dpdGNoTWFwKChhY3Rpb246IFNlbmRQYXNzd29yZCkgPT4gdGhpcy5hdXRoU2VydmljZS5zZW5kUGFzc3dvcmQoYWN0aW9uLnBheWxvYWQpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4gbmV3IFNlbmRQYXNzd29yZFN1Y2Nlc3MoKSksXG4gICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IG9mKG5ldyBTZW5kUGFzc3dvcmRGYWlsdXJlKGVycm9yKSkpXG4gICAgKSlcbiAgKTtcblxuICBARWZmZWN0KHsgZGlzcGF0Y2g6IGZhbHNlIH0pXG4gIFNlbmRQYXNzd29yZFN1Y2Nlc3MkID0gdGhpcy5hY3Rpb25zLnBpcGUoXG4gICAgb2ZUeXBlKEFVVEhfQUNUSU9OU19UWVBFLlNFTkRfUEFTU1dPUkRfU1VDQ0VTUyksXG4gICAgdGFwKCgpID0+IHRoaXMudG9hc3RTZXJ2aWNlLnN1Y2Nlc3MoXG4gICAgICBnZXQodGhpcy50cmFkdWN0aW9ucyB8fCB7fSwgJ21lc3NhZ2VzLnBhc3N3b3JkUmVzZXRTdWNjZXNzJywgJ0FuIGVtYWlsIGZvciByZXNldHRpbmcgeW91ciBwYXNzd29yZCBoYXMgYmVlbiBzZW50IHRvIHlvdXIgYWRkcmVzcy4nKVxuICAgICkpXG4gICk7XG5cbiAgQEVmZmVjdCh7IGRpc3BhdGNoOiBmYWxzZSB9KVxuICBTZW5kUGFzc3dvcmRGYWlsdXJlJCA9IHRoaXMuYWN0aW9ucy5waXBlKFxuICAgIG9mVHlwZShBVVRIX0FDVElPTlNfVFlQRS5TRU5EX1BBU1NXT1JEX0ZBSUxVUkUpLFxuICAgIHRhcCgoKSA9PiB0aGlzLnRvYXN0U2VydmljZS5lcnJvcihcbiAgICAgIGdldCh0aGlzLnRyYWR1Y3Rpb25zIHx8IHt9LCAnbWVzc2FnZXMucGFzc3dvcmRSZXNldEZhaWx1cmUnLCAnQW4gZXJyb3Igb2NjdXJlZC4gUGxlYXNlIHRyeSBhZ2Fpbi4nKVxuICAgICkpXG4gICk7XG59XG4iXX0=